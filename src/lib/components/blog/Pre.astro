---
import { randomId } from "$lib/utils/randomId";
import CodeBlockTitle from "./CodeBlockTitle.astro";
import CopyCodeButton from "./CopyCodeButton.astro";

let props = Astro.props as {
  "data-language": string;
  "data-meta": string;
};

let { "data-language": lang, "data-meta": meta } = props;
let noCopy, tab, title;

if (meta) {
  const titleMetaMatch = meta.match(
    new RegExp("(title=)(?:[\"'])(.*?)(?:[\"'])"),
  );

  if (titleMetaMatch && titleMetaMatch.length > 2) {
    title = titleMetaMatch[2];
  }

  const tabMetaMatch = meta.match(new RegExp("(tab=)(?:[\"'])(.*?)(?:[\"'])"));

  if (tabMetaMatch && tabMetaMatch.length > 2) {
    tab = tabMetaMatch[2];
  }

  const noCopyMatch = meta.match(new RegExp("nocopy"));

  if (noCopyMatch) {
    noCopy = true;
  }
}

const blockId = randomId("code-block");
---

<div
  class:list={{ feature: !tab, "feature-tabpanel": tab }}
  role={tab ? "tabpanel" : undefined}
  id={tab ? `panel-${tab}` : undefined}
  aria-labelledby={tab ? `tab-${tab}` : undefined}>
  {
    !tab && ((lang && lang !== "plaintext") || title) && (
      <div class="feature-title-bar">
        <CodeBlockTitle slot="title" {lang} {title} />
      </div>
    )
  }

  <pre
    data-block-id={blockId}
    {...props}>
    <slot />
    {!noCopy && <CopyCodeButton blockId={blockId} />}
  </pre>
</div>

<script>
  const containers = document.querySelectorAll("pre[data-block-id]");

  containers.forEach((container) => {
    let timeout: ReturnType<typeof setTimeout>;

    container.addEventListener("mouseover", () => {
      container.classList.add("hover");
      clearTimeout(timeout);
    });

    container.addEventListener("mouseout", () => {
      timeout = setTimeout(() => {
        container.classList.remove("hover");
      }, 1000);
    });
  });
</script>

<style is:global>
  .code-block-title-bar {
    display: grid;
    grid-template-columns: 1fr max-content max-content;

    padding-top: 4px;
    padding-bottom: 2px;

    background-color: var(--background-three);
    border-bottom: 1px solid var(--outline);
  }

  .filetype-icon {
    width: 16px;
    height: 16px;

    margin-top: -1px;
  }

  pre {
    background-color: unset !important;
    display: grid;
    position: relative;
  }

  pre code {
    /* Use grid as it's the only thing that lets us do full-width highlights */
    display: grid;
    overflow-x: auto;
    overflow-y: clip;

    padding-bottom: 16px;
    padding-top: 16px;
  }

  pre span {
    /* Disable italic styles in shiki themes */
    font-style: normal !important;
    display: inline-block;
    min-height: 1.25em;
  }

  pre .code-highlight:not(.line) {
    margin-left: -4px;
    margin-right: -4px;

    padding: 1px 4px;

    margin-top: 1px;
    margin-bottom: 1px;
  }

  pre .code-highlight.line {
    border-left-width: 1.5px;
    border-left-style: solid;
  }

  pre .code-highlight:not(.line) {
    border-radius: 3px;

    border-bottom-width: 1.5px;
    border-bottom-style: solid;
  }

  .code-highlight:not(:has(+ .code-highlight)) {
    padding-bottom: 0.175em;
  }

  .line:not(.code-highlight) + .code-highlight,
  line.code-highlight:first-of-type {
    padding-top: 0.175em;
  }

  pre .indent {
    display: inline-block;
    position: relative;
    left: var(--indent-offset);
  }

  pre .indent:empty {
    height: 1lh;
    vertical-align: bottom;
  }

  pre .indent::before {
    content: "";
    position: absolute;

    top: calc(50% - 1px);
    left: 1px;

    width: 2px;
    height: 2px;
    border-radius: 100%;

    opacity: 0.15;
    background-color: currentColor;
  }

  /* Code folding */

  details {
    border-top: 1px solid var(--shadow);
    border-bottom: 1px solid var(--shadow);

    position: relative;
    overflow: hidden;
  }

  details::details-content {
    display: block;
    block-size: 0;
    overflow: hidden;

    transition-property: block-size, content-visibility;
    transition-duration: var(--transition-med);
    transition-behavior: allow-discrete;
  }

  details[open]::details-content {
    block-size: auto;
    block-size: calc-size(auto);
  }

  details summary {
    list-style: none;

    cursor: pointer;

    padding-top: 3px;
    padding-bottom: 1px;
  }

  details summary span {
    filter: grayscale(0.4) brightness(0.8);
    transition: filter var(--transition-blink);
  }

  details[open] summary {
    border-bottom: 1px solid var(--shadow);
  }

  details[open] summary span {
    filter: none;
  }

  summary::before {
    content: "";

    position: absolute;
    align-self: center;

    top: 1px;
    left: 0;

    width: 21px;
    height: 21px;

    background-color: var(--text-two);
    mask-image: var(--expand-lines-icon);
    mask-repeat: no-repeat;
    mask-position: 50%;
  }

  summary::after {
    content: "+ " attr(data-lines-folded) " more lines";

    color: var(--text-three);
    margin-left: 16px;
    font-style: italic;

    transition-property: opacity, content-visibility;
    transition-duration: var(--transition-blink);
  }

  details[open] summary::after {
    opacity: 0;
    content-visibility: hidden;
  }

  details[open] summary::before {
    mask-image: var(--compress-lines-icon);
  }
</style>
